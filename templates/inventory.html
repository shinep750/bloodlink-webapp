{% extends 'base.html' %}

{% block content %}
     <!-- Add Blood Bag Page -->
        <div id="add" class="page hidden">
            <h1 class="text-3xl font-bold text-white mb-6">Add New Blood Bag</h1>
            <div class="main-content-card rounded-xl p-8 max-w-lg mx-auto">
                <form id="add-blood-bag-form">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="blood-group" class="block mb-2 text-sm font-medium">Blood Group</label>
                            <select id="blood-group" class="w-full p-2.5 bg-gray-700 border border-gray-600 rounded-lg text-white" required>
                                <option>A+</option><option>A-</option><option>B+</option><option>B-</option>
                                <option>AB+</option><option>AB-</option><option>O+</option><option>O-</option>
                            </select>
                        </div>
                        <div>
                            <label for="donor-id" class="block mb-2 text-sm font-medium">Donor ID</label>
                            <input type="text" id="donor-id" class="w-full p-2.5 bg-gray-700 border border-gray-600 rounded-lg text-white" required>
                        </div>
                    </div>
                    <div class="mt-6">
                        <label for="donation-date" class="block mb-2 text-sm font-medium">Donation Date</label>
                        <input type="date" id="donation-date" class="w-full p-2.5 bg-gray-700 border border-gray-600 rounded-lg text-white" required>
                    </div>
                    <div class="mt-8 flex justify-end">
                        <button type="submit" class="btn-primary font-semibold py-2 px-6 rounded-lg">Add to Inventory</button>
                    </div>
                </form>
            </div>
        </div>

    <div class="card filter-card">
        <form method="get" action="{{ url_for('view_inventory') }}">
            <input type="text" name="blood_group" placeholder="Filter by blood group..." value="{{ search_group }}">
            <select name="bank_id">
                <option value="">Filter by Blood Bank...</option>
                {% for bank in banks %}
                    <option value="{{ bank.bank_id }}" {% if search_bank|string == bank.bank_id|string %}selected{% endif %}>
                        {{ bank.bank_name }}
                    </option>
                {% endfor %}
            </select>
            <button type="submit" class="btn btn-primary">Apply Filters</button>
        </form>
    </div>

     <!-- Inventory Page -->
        <div id="inventory" class="page hidden">
            <h1 class="text-3xl font-bold text-white mb-6">Inventory Management</h1>
            <div class="main-content-card rounded-xl overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="table-header text-xs uppercase">
                            <tr>
                                <th class="p-4">Blood Type</th>
                                <th class="p-4">Donor ID</th>
                                <th class="p-4">Donation Date</th>
                                <th class="p-4">Expires On</th>
                                <th class="p-4">Status</th>
                                <th class="p-4 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-table-body">
                            <!-- JS will populate this -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    {% if not current_user.is_admin %}
        <div id="transfusionModal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="closeTransfusionModal()">&times;</span>
                <h2>Record Transfusion</h2>
                <p>You are marking blood bag #<strong id="modalBagId"></strong> (Group <strong id="modalBloodGroup"></strong>) as used.</p>
                
                <form id="transfusionForm" method="post">
                    <div id="existingRecipientSection">
                        <div class="form-group">
                            <label for="recipient_id">Select Existing Recipient</label>
                            <select name="recipient_id" id="recipient_id">
                                <option value="">-- Please select a recipient --</option>
                                {% for recipient in recipients %}
                                <option value="{{ recipient.recipient_id }}">{{ recipient.first_name }} {{ recipient.last_name }} ({{ recipient.blood_group }})</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="newRecipientToggle" onchange="toggleNewRecipientForm()">
                        <label for="newRecipientToggle">Or, enter a new recipient</label>
                    </div>
                    <div id="newRecipientSection" style="display: none; border-top: 1px solid var(--border-color); margin-top: 1rem; padding-top: 1rem;">
                        <div class="form-group">
                            <label for="new_recipient_first_name">First Name</label>
                            <input type="text" name="new_recipient_first_name" id="new_recipient_first_name">
                        </div>
                        <div class="form-group">
                            <label for="new_recipient_last_name">Last Name</label>
                            <input type="text" name="new_recipient_last_name" id="new_recipient_last_name">
                        </div>
                        <!-- THE FIX: New field for Hospital Name -->
                        <div class="form-group">
                            <label for="new_recipient_hospital">Hospital Name</label>
                            <input type="text" name="new_recipient_hospital" id="new_recipient_hospital">
                        </div>
                        <div class="form-group">
                            <label for="new_recipient_blood_group">Blood Group</label>
                            <select name="new_recipient_blood_group" id="new_recipient_blood_group">
                                <option value="">Select...</option>
                                <option value="A+">A+</option> <option value="A-">A-</option>
                                <option value="B+">B+</option> <option value="B-">B-</option>
                                <option value="AB+">AB+</option> <option value="AB-">AB-</option>
                                <option value="O+">O+</option> <option value="O-">O-</option>
                            </select>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Confirm Transfusion</button>
                </form>
            </div>
        </div>
    {% endif %}
{% endblock %}

{% block scripts %}
    {% if not current_user.is_admin %}
    <script>
        const modal = document.getElementById('transfusionModal');
        const form = document.getElementById('transfusionForm');
        const modalBagId = document.getElementById('modalBagId');
        const modalBloodGroup = document.getElementById('modalBloodGroup');
        const existingRecipientSection = document.getElementById('existingRecipientSection');
        const newRecipientSection = document.getElementById('newRecipientSection');
        const newRecipientToggle = document.getElementById('newRecipientToggle');

        function openTransfusionModal(bagId, bloodGroup) {
            modalBagId.textContent = bagId;
            modalBloodGroup.textContent = bloodGroup;
            form.action = `/inventory/use/${bagId}`;
            modal.style.display = 'block';
        }

        function closeTransfusionModal() {
            modal.style.display = 'none';
            newRecipientToggle.checked = false;
            toggleNewRecipientForm();
            form.reset();
        }
        
        function toggleNewRecipientForm() {
            if (newRecipientToggle.checked) {
                existingRecipientSection.style.display = 'none';
                newRecipientSection.style.display = 'block';
                document.getElementById('recipient_id').required = false;
                document.getElementById('new_recipient_first_name').required = true;
                document.getElementById('new_recipient_last_name').required = true;
                document.getElementById('new_recipient_hospital').required = true; // Make hospital required
                document.getElementById('new_recipient_blood_group').required = true;
            } else {
                existingRecipientSection.style.display = 'block';
                newRecipientSection.style.display = 'none';
                document.getElementById('recipient_id').required = true;
                document.getElementById('new_recipient_first_name').required = false;
                document.getElementById('new_recipient_last_name').required = false;
                document.getElementById('new_recipient_hospital').required = false;
                document.getElementById('new_recipient_blood_group').required = false;
            }
        }

        window.onclick = function(event) {
            if (event.target == modal) {
                closeTransfusionModal();
            }
        }
    </script>
    {% endif %}
{% endblock %}

